<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3D-печать в Казахстане</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
body{margin:0;font-family:Arial}
#map{height:100vh}
button{
 position:fixed;left:10px;z-index:5000;
 padding:8px 12px;border:none;border-radius:5px;
 font-weight:bold;cursor:pointer
}
#google-btn{top:10px;background:#4285F4;color:#fff}
#add-marker-btn{top:50px;background:#00c853;color:#fff;display:none}
#logout-btn{top:90px;background:#d33;color:#fff;display:none}
#user-avatar{
 position:fixed;top:10px;left:10px;
 width:40px;height:40px;border-radius:50%;
 display:none;z-index:5000;cursor:pointer
}
#user-points{
 position:fixed;top:140px;left:10px;
 background:#fff;padding:10px;border-radius:6px;
 max-height:50vh;overflow:auto;display:none;z-index:5000;width:280px
}
.point-item{border-bottom:1px solid #ddd;font-size:13px;padding:5px}
#modal{
 position:fixed;inset:0;background:rgba(0,0,0,.5);
 display:none;align-items:center;justify-content:center;z-index:6000
}
#modal-content{
 background:#fff;width:340px;padding:15px;
 border-radius:8px;max-height:90vh;overflow:auto
}
input{width:100%;margin-bottom:6px;padding:6px}
</style>
</head>
<body>

<div id="map"></div>

<button id="google-btn">Войти через Google</button>
<button id="add-marker-btn">Добавить точку</button>
<button id="logout-btn">Выйти</button>
<img id="user-avatar">
<div id="user-points"></div>

<div id="modal">
 <div id="modal-content">
  <h3>Добавить 3D-печать</h3>
  <input id="f-name" placeholder="Имя">
  <input id="f-printer" placeholder="Принтер">
  <input id="f-materials" placeholder="Материалы">
  <input id="f-price" placeholder="Цена">
  <input id="f-address" placeholder="Адрес">
  <input id="f-wa" placeholder="WhatsApp">
  <input id="f-tg" placeholder="Telegram">
  <input id="f-ig" placeholder="Instagram">
  <button id="save">Сохранить</button>
  <button onclick="closeModal()">Отмена</button>
 </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ===== FIREBASE =====
firebase.initializeApp({
 apiKey: "AIzaSyCRZOp8TGfz2f4pvh3S69zixDKkAP3wmNo",
 authDomain: "kaz3d-c2304.firebaseapp.com",
 projectId: "kaz3d-c2304"
});
const auth=firebase.auth();
const db=firebase.firestore();

// ===== MAP =====
const map=L.map('map').setView([48.5,68],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
const markers=L.layerGroup().addTo(map);
let selectedLatLng=null;

// ===== LOAD MARKERS =====
function loadMarkers(){
 markers.clearLayers();
 db.collection("3dpoints").get().then(snap=>{
  snap.forEach(doc=>{
   const d=doc.data();
   const wa=d.whatsapp?`<a href="https://wa.me/${d.whatsapp}">WA</a>`:'нет';
   const tg=d.telegram?`<a href="https://t.me/${d.telegram.replace('@','')}">TG</a>`:'нет';
   L.marker([d.lat,d.lng]).addTo(markers)
    .bindPopup(`
<b><a href="user.html?uid=${d.uid}" target="_blank">${d.name}</a></b><br>
Принтер: ${d.printer}<br>
Материалы: ${d.materials}<br>
Цена: ${d.price}<br>
Адрес: ${d.address}<br>
${wa} | ${tg}
`);
  });
 });
}

// ===== AUTH =====
auth.onAuthStateChanged(user=>{
 document.getElementById('google-btn').style.display=user?'none':'block';
 document.getElementById('add-marker-btn').style.display=user?'block':'none';
 document.getElementById('logout-btn').style.display=user?'block':'none';
 const avatar=document.getElementById('user-avatar');
 if(user){
  avatar.src=user.photoURL;
  avatar.style.display='block';
  loadUserPoints(user.uid);
 }else{
  avatar.style.display='none';
  document.getElementById('user-points').style.display='none';
 }
 loadMarkers();
});

// ===== USER POINTS =====
function loadUserPoints(uid){
 const c=document.getElementById('user-points');
 c.innerHTML='';
 db.collection("3dpoints").where("uid","==",uid).get().then(snap=>{
  snap.forEach(doc=>{
   const d=doc.data();
   c.innerHTML+=`<div class="point-item">
   ${d.name}<br>
   <button onclick="del('${doc.id}')">Удалить</button>
   </div>`;
  });
 });
}
window.del=id=>{
 if(confirm("Удалить?")){
  db.collection("3dpoints").doc(id).delete().then(loadMarkers);
 }
}

// ===== ADD =====
document.getElementById('add-marker-btn').onclick=()=>{
 alert("Кликни на карте");
 map.once('click',e=>{
  selectedLatLng=e.latlng;
  document.getElementById('modal').style.display='flex';
 });
}
function closeModal(){document.getElementById('modal').style.display='none'}

document.getElementById('save').onclick=()=>{
 const u=auth.currentUser;
 db.collection("3dpoints").add({
  name:f-name.value,
  printer:f-printer.value,
  materials:f-materials.value,
  price:f-price.value,
  address:f-address.value,
  whatsapp:f-wa.value,
  telegram:f-tg.value,
  instagram:f-ig.value,
  lat:selectedLatLng.lat,
  lng:selectedLatLng.lng,
  uid:u.uid
 }).then(()=>{
  closeModal();
  loadMarkers();
  loadUserPoints(u.uid);
 });
}

// ===== LOGIN / LOGOUT =====
document.getElementById('google-btn').onclick = ()=>{ auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
document.getElementById('logout-btn').onclick = ()=>{ auth.signOut(); }
</script>
</body>
</html>
